# @package _global_

# to execute this experiment run:
# python train.py experiment=example

defaults:
  - override /callbacks: default.yaml
  - override /datamodule: datasets/voxceleb.yaml
  - override /module: sv.yaml
  - override /trainer: gpu.yaml
  - override /logger: tensorboard.yaml


# all parameters below will be merged with parameters from default configurations set above
# this allows you to overwrite only specified parameters

tags: ["voxceleb",  "sv", "ecapa", "Plateau", "speechbrain_ecapa"]
seed: 42

trainer:
  min_epochs: 8
  max_epochs: 15
  gradient_clip_val: 1.0
  num_sanity_val_steps: 0

callbacks:
  model_checkpoint:
    mode: max
    monitor: ${replace:"valid/__metric__"}
  early_stopping:
    mode: max
    monitor: ${replace:"valid/__metric__"}
    patience: 8

datamodule:
  dataset:
    max_duration: 3.0

  loaders:
    train:
      batch_size: 32
    valid:
      batch_size: 32
    test:
      batch_size: 4
    enrollment:
      batch_size: 1

module:
  normalize_test_scores: True

  lr_scheduler:
    scheduler:
      _target_: torch.optim.lr_scheduler.ReduceLROnPlateau
      mode: "max"
      factor: 0.25
      min_lr: 1.0e-7
      patience: 2
      verbose: True
    extras:
      monitor: ${replace:"valid/__metric__"}
      interval: "epoch"
      frequency: 1


  ### Data for augmentation ###

  data_augemntation:

    noise_dataset_url: https://www.dropbox.com/scl/fi/a09pj97s5ifan81dqhi4n/noises.zip?rlkey=j8b0n9kdjdr32o1f06t0cw5b7&dl=1
    rir_dataset_url: https://www.dropbox.com/scl/fi/linhy77c36mu10965a836/RIRs.zip?rlkey=pg9cu8vrpn2u173vhiqyu743u&dl=1
    data_folder_rir_noises: ${datamodule.dataset.data_dir}/RIRS_NOISES
    noise_annotation: ${module.data_augemntation.data_folder_rir_noises}/noise.csv
    rir_annotation: ${module.data_augemntation.data_folder_rir_noises}/reverb.csv

    prepare_noise_data:
      _target_: speechbrain.augment.preparation.prepare_dataset_from_URL
      URL: ${module.data_augemntation.noise_dataset_url}
      dest_folder: ${module.data_augemntation.data_folder_rir_noises}/noise
      ext: wav
      csv_file: ${module.data_augemntation.noise_annotation}

    prepare_rir_data:
      _target_: speechbrain.augment.preparation.prepare_dataset_from_URL
      URL: ${module.data_augemntation.rir_dataset_url}
      dest_folder: ${module.data_augemntation.data_folder_rir_noises}/rir
      ext: wav
      csv_file: ${module.data_augemntation.rir_annotation}

    augmentations:
      add_noise:
        _target_: speechbrain.augment.time_domain.AddNoise
        csv_file: ${module.data_augemntation.noise_annotation}
        snr_low: 0
        snr_high: 15
        noise_sample_rate: ${datamodule.dataset.sample_rate}
        clean_sample_rate: ${datamodule.dataset.sample_rate}
        num_workers: ${datamodule.loaders.train.num_workers}

      add_reverb:
        _target_: speechbrain.augment.time_domain.AddReverb
        csv_file: ${module.data_augemntation.rir_annotation}
        reverb_sample_rate: ${datamodule.dataset.sample_rate}
        clean_sample_rate: ${datamodule.dataset.sample_rate}
        num_workers: ${datamodule.loaders.train.num_workers}

      drop_freq:
        _target_: speechbrain.augment.time_domain.DropFreq
        drop_freq_low: 0
        drop_freq_high: 1
        drop_freq_count_low: 1
        drop_freq_count_high: 3
        drop_freq_width: 0.05

      drop_chunk:
        _target_: speechbrain.augment.time_domain.DropChunk
        drop_length_low: 1000
        drop_length_high: 2000
        drop_count_low: 1
        drop_count_high: 5

      wav_augmenter:
        _target_: speechbrain.augment.augmenter.Augmenter
        parallel_augment: true
        concat_original: true
        min_augmentations: 4
        max_augmentations: 4
        augment_prob: 1.0
        augmentations:
          - ${module.data_augemntation.augmentations.add_noise}
          - ${module.data_augemntation.augmentations.add_reverb}
          - ${module.data_augemntation.augmentations.drop_freq}
          - ${module.data_augemntation.augmentations.drop_chunk}
